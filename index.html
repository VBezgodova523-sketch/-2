<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>audiopleer player</title>
  <style>
    :root{ --p:#7c3aed; --a:#f97316; --t:#e8eefc; --m:#a9b6d6; }
    body{margin:0;background:transparent;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    #gaudio{width:min(520px,100%);color:var(--t);background:transparent;user-select:none}
    .card{
      border-radius:24px;padding:18px 18px 14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(15,20,34,.38);
      backdrop-filter:blur(10px);
      box-shadow:0 12px 40px rgba(0,0,0,.28);
      overflow:hidden;
    }
    .top{display:flex;gap:14px;align-items:center}
    .ring{width:112px;height:112px;border-radius:999px;position:relative;flex:0 0 auto;
      background:conic-gradient(from 180deg, var(--p), rgba(255,255,255,.10), var(--p));padding:6px;}
    .ring::after{content:"";position:absolute;inset:6px;border-radius:999px;background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);}
    .cover{position:absolute;inset:14px;border-radius:999px;background-size:cover;background-position:center;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.12);z-index:2;}
    .meta{min-width:0}
    .title{font-size:14px;font-weight:800;line-height:1.2;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .artist{margin-top:6px;font-size:12px;color:var(--m);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-height:16px;}

    .controls{display:flex;align-items:center;justify-content:space-between;margin-top:14px;gap:10px;}
    .btn{width:40px;height:40px;border-radius:14px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);color:var(--t);display:grid;place-items:center;cursor:pointer;}
    .btn.primary{width:54px;height:54px;border-radius:18px;background:rgba(0,0,0,.22);
      border-color:rgba(255,255,255,.18);box-shadow:0 12px 28px rgba(0,0,0,.20);}
    .btn.tog{width:auto;height:40px;padding:0 12px;font-size:12px;color:var(--m);gap:8px;display:flex;align-items:center;justify-content:center;}
    .btn.tog b{color:var(--t);font-weight:800;}

    .progress{margin-top:14px}
    input[type="range"]{width:100%;-webkit-appearance:none;appearance:none;height:6px;border-radius:999px;
      background:linear-gradient(90deg,var(--a) 0%,rgba(255,255,255,.14) 0%);outline:none;}
    input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:14px;height:14px;border-radius:50%;
      background:var(--a);border:1px solid rgba(255,255,255,.25);box-shadow:0 8px 20px rgba(0,0,0,.35);cursor:pointer;}
    .time{display:flex;justify-content:space-between;margin-top:8px;font-size:11px;color:var(--m);}

    /* VOLUME */
    .volRow{margin-top:10px;display:flex;align-items:center;gap:10px;}
    .volIcon{font-size:14px;color:var(--m);width:18px;text-align:center}
    .vol{flex:1}
    .muteBtn{width:40px;height:40px;border-radius:14px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);color:var(--t);display:grid;place-items:center;cursor:pointer;}

    .bottom{display:flex;align-items:center;justify-content:space-between;margin-top:12px;}
    .listBtn{width:auto;height:38px;padding:0 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);color:var(--m);cursor:pointer;font-size:12px;}
    .badge{font-size:10px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);color:var(--m);}

    .listPanel{margin-top:12px;border-top:1px solid rgba(255,255,255,.12);padding-top:12px;display:none;}
    .listPanel.open{display:block}
    .listTitle{font-size:12px;color:var(--m);display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
    .track{padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.16);
      margin-bottom:8px;cursor:pointer;}
    .track:hover{border-color:rgba(255,255,255,.22)}
    .track.active{border-color:rgba(255,255,255,.28)}
    .statusLine{margin-top:10px;font-size:12px;color:var(--m);white-space:pre-wrap;line-height:1.35;}
    .build{margin-top:8px;font-size:10px;color:rgba(255,255,255,.35);text-align:right;user-select:text;}
  </style>
</head>
<body>
  <div id="gaudio">
    <div class="card">
      <div class="top">
        <div class="ring" aria-hidden="true"><div class="cover" id="cover"></div></div>
        <div class="meta">
          <p class="title" id="title">‚Äî</p>
          <div class="artist" id="subtitle">–ó–∞–≥—Ä—É–∂–∞—é —Ç—Ä–µ–∫–∏‚Ä¶</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="prev">‚èÆ</button>
        <button class="btn primary" id="play"><span id="playIc">‚ñ∂</span></button>
        <button class="btn" id="next">‚è≠</button>
        <button class="btn tog" id="shuffle">üîÄ <b id="shufState">OFF</b></button>
      </div>

      <div class="progress">
        <input id="seek" type="range" min="0" max="1000" value="0" />
        <div class="time">
          <span id="cur">0:00</span>
          <span id="tot">0:00</span>
        </div>
      </div>

      <div class="volRow">
        <div class="volIcon" id="volIc">üîä</div>
        <input class="vol" id="vol" type="range" min="0" max="100" value="85" />
        <button class="muteBtn" id="mute" title="Mute">üîá</button>
      </div>

      <div class="bottom">
        <button class="listBtn" id="listBtn">‚ò∞ –ü–ª–µ–π–ª–∏—Å—Ç</button>
        <span class="badge" id="count">0</span>
      </div>

      <div class="listPanel" id="list"></div>
      <div class="statusLine" id="status"></div>
      <div class="build">BUILD: v4-vol-progress-genially</div>
    </div>
  </div>

<script>
(() => {
  const GITHUB_OWNER="onegovakota-cmyk";
  const GITHUB_REPO="audiopleer";
  const GITHUB_PATH="";
  const GITHUB_REF="main";
  const COVER_URL="https://images.unsplash.com/photo-1511379938547-c1f69419868d?w=800&q=80&auto=format&fit=crop";
  const audioExt=/\.(mp3|wav|ogg|m4a|aac)$/i;

  const $=id=>document.getElementById(id);
  const $cover=$("cover"), $title=$("title"), $subtitle=$("subtitle"), $status=$("status");
  const $play=$("play"), $playIc=$("playIc"), $prev=$("prev"), $next=$("next");
  const $shuffle=$("shuffle"), $shufState=$("shufState");
  const $seek=$("seek"), $cur=$("cur"), $tot=$("tot");
  const $vol=$("vol"), $volIc=$("volIc"), $mute=$("mute");
  const $listBtn=$("listBtn"), $list=$("list"), $count=$("count");

  $cover.style.backgroundImage = COVER_URL ? `url("${COVER_URL}")` : "none";

  const audio=new Audio();
  audio.preload="metadata";

  let tracks=[], index=0, isShuffle=false, bag=[], seeking=false, raf=null, lastVol=0.85;

  function fmt(s){ if(!isFinite(s)||s<0) return "0:00"; const m=Math.floor(s/60), r=Math.floor(s%60); return m+":"+String(r).padStart(2,"0"); }
  function setBar(el,p){ p=Math.max(0,Math.min(100,p)); el.style.background=`linear-gradient(90deg,var(--a) ${p}%, rgba(255,255,255,.14) ${p}%)`; }
  function nameFrom(url){
    try{const u=new URL(url); return decodeURIComponent(u.pathname.split("/").pop()).replace(audioExt,"");}
    catch{ return decodeURIComponent((url.split("/").pop()||"").split("?")[0]).replace(audioExt,"");}
  }
  function isAbs(u){ return /^https?:\/\//i.test(u||""); }

  function setVol(v01){
    const v=Math.max(0,Math.min(1,v01));
    lastVol=v;
    audio.volume=v;
    $vol.value=String(Math.round(v*100));
    setBar($vol, v*100);
    $volIc.textContent = (audio.muted||v===0) ? "üîá" : (v<0.5 ? "üîâ" : "üîä");
    $mute.textContent = audio.muted ? "üîà" : "üîá";
  }
  setVol(0.85);

  $vol.addEventListener("input", ()=>{ audio.muted=false; setVol(Number($vol.value)/100); });
  $mute.addEventListener("click", ()=>{ audio.muted=!audio.muted; setVol(lastVol); });

  function curTrack(){ return tracks[index]||null; }
  function renderMeta(){
    const t=curTrack();
    if(!t){ $title.textContent="‚Äî"; $subtitle.textContent="–ù–µ—Ç —Ç—Ä–µ–∫–æ–≤"; return; }
    $title.textContent=t.title || nameFrom(t.url);
    $subtitle.textContent = (audio.paused ? "‚è∏ Paused" : "‚ñ∂ Playing‚Ä¶");
  }

  function renderList(){
    $count.textContent=String(tracks.length);
    $list.innerHTML = `<div class="listTitle"><span>–ü–ª–µ–π–ª–∏—Å—Ç</span><span class="badge">${tracks.length}</span></div>` +
      tracks.map((t,i)=>`<div class="track ${i===index?"active":""}" data-i="${i}">${(t.title||nameFrom(t.url))}</div>`).join("");
    Array.from($list.querySelectorAll(".track")).forEach(el=>{
      el.onclick=()=>loadAndPlay(Number(el.dataset.i), true);
    });
  }
  function refreshActive(){
    Array.from($list.querySelectorAll(".track")).forEach(el=>{
      el.classList.toggle("active", Number(el.dataset.i)===index);
    });
  }

  function updateProgress(){
    if(!isFinite(audio.duration)||audio.duration<=0){
      $tot.textContent="0:00";
      $cur.textContent=fmt(audio.currentTime||0);
      return;
    }
    $tot.textContent=fmt(audio.duration);
    $cur.textContent=fmt(audio.currentTime);
    const p=audio.currentTime/audio.duration;
    if(!seeking){
      $seek.value=String(Math.round(p*1000));
      setBar($seek, p*100);
    }
  }
  function startRAF(){
    stopRAF();
    const tick=()=>{ updateProgress(); if(!audio.paused) raf=requestAnimationFrame(tick); };
    raf=requestAnimationFrame(tick);
  }
  function stopRAF(){ if(raf) cancelAnimationFrame(raf); raf=null; }

  function syncPlayUI(){
    const playing=!audio.paused;
    $playIc.textContent = playing ? "‚è∏" : "‚ñ∂";
    $subtitle.textContent = playing ? "‚ñ∂ Playing‚Ä¶" : "‚è∏ Paused";
  }

  function load(i){
    if(!tracks.length) return;
    index=(i+tracks.length)%tracks.length;
    const t=curTrack();
    if(!isAbs(t.url)){ $status.textContent="–ù—É–∂–Ω–∞ –∞–±—Å–æ–ª—é—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞ https://\n"+String(t.url||""); return; }

    $seek.value="0"; setBar($seek,0);
    $cur.textContent="0:00"; $tot.textContent="0:00";

    audio.src=t.url;
    renderMeta();
    refreshActive();
  }

  async function loadAndPlay(i, autoplay){
    load(i);
    if(!autoplay) return;
    try{
      await audio.play(); // <-- –≤ iframe Genially —Ç—É—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å reject
      syncPlayUI();
      startRAF();
    }catch(e){
      // –í–∞–∂–Ω–æ: –ø–æ–∫–∞–∂–µ–º, —á—Ç–æ play() –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
      $status.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å audio.play().\n–ü—Ä–∏—á–∏–Ω–∞: " + (e?.name || e) +
        "\n–ü–æ–¥—Å–∫–∞–∑–∫–∞: –¥–æ–±–∞–≤—å allow=\"autoplay\" –≤ iframe –∏ –æ—Ç–∫—Ä–æ–π –ø–ª–µ–µ—Ä –∫–ª–∏–∫–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.";
      syncPlayUI();
    }
  }

  function ensureBag(){
    const arr=[];
    for(let i=0;i<tracks.length;i++) if(i!==index) arr.push(i);
    for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    bag=arr;
  }
  function nextIndex(){
    if(!tracks.length) return 0;
    if(isShuffle){ if(!bag.length) ensureBag(); return bag.shift(); }
    return (index+1)%tracks.length;
  }
  function prevIndex(){
    if(!tracks.length) return 0;
    return (index-1+tracks.length)%tracks.length;
  }

  $play.onclick = async ()=>{
    if(!tracks.length) return;
    if(!audio.src) load(index);

    if(audio.paused){
      try{
        await audio.play();
        syncPlayUI();
        startRAF();
      }catch(e){
        $status.textContent = "play() –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: " + (e?.name || e) +
          "\n–í iframe –ø—Ä–æ–≤–µ—Ä—å allow=\"autoplay\" –∏ –¥–æ–±–∞–≤—å –ø–∞—Ä–∞–º–µ—Ç—Ä ?v=... —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –∫—ç—à.";
      }
    }else{
      audio.pause();
      syncPlayUI();
      stopRAF();
      updateProgress();
    }
  };
  $next.onclick=()=>loadAndPlay(nextIndex(), true);
  $prev.onclick=()=>loadAndPlay(prevIndex(), true);

  $shuffle.onclick=()=>{
    isShuffle=!isShuffle;
    $shufState.textContent=isShuffle?"ON":"OFF";
    bag=[];
    if(isShuffle) ensureBag();
  };

  $listBtn.onclick=()=> $list.classList.toggle("open");

  $seek.addEventListener("pointerdown", ()=>seeking=true);
  window.addEventListener("pointerup", ()=>seeking=false);
  $seek.addEventListener("input", ()=>{
    if(!isFinite(audio.duration)||audio.duration<=0) return;
    const p=Number($seek.value)/1000;
    setBar($seek, p*100);
    $cur.textContent=fmt(p*audio.duration);
  });
  $seek.addEventListener("change", ()=>{
    if(!isFinite(audio.duration)||audio.duration<=0) return;
    const p=Number($seek.value)/1000;
    audio.currentTime=p*audio.duration;
    updateProgress();
  });

  audio.addEventListener("loadedmetadata", ()=>{ updateProgress(); });
  audio.addEventListener("timeupdate", updateProgress);
  audio.addEventListener("play", ()=>{ syncPlayUI(); startRAF(); });
  audio.addEventListener("pause", ()=>{ syncPlayUI(); stopRAF(); updateProgress(); });
  audio.addEventListener("ended", ()=>{ stopRAF(); loadAndPlay(nextIndex(), true); });

  async function fetchJson(url){
    const res=await fetch(url,{headers:{"Accept":"application/vnd.github+json"}});
    return {ok:res.ok, status:res.status, data: await res.json().catch(()=>null)};
  }
  function contentsUrl(owner, repo, path, ref){
    const clean=(path||"").trim().replace(/^\/+|\/+$/g,"");
    const enc = clean ? clean.split("/").map(encodeURIComponent).join("/") : "";
    return `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${enc}?ref=${encodeURIComponent(ref)}`;
  }

  async function loadTracks(){
    const url=contentsUrl(GITHUB_OWNER,GITHUB_REPO,GITHUB_PATH,GITHUB_REF);
    const res=await fetchJson(url);
    if(!res.ok || !Array.isArray(res.data)) throw new Error("GitHub contents –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å");
    tracks = res.data.filter(x=>x?.type==="file" && audioExt.test(x.name||""))
      .map(x=>({url:x.download_url, title:(x.name||"").replace(audioExt,"")}));
  }

  (async ()=>{
    try{
      $subtitle.textContent="–ó–∞–≥—Ä—É–∂–∞—é —Ç—Ä–µ–∫–∏‚Ä¶";
      await loadTracks();
      if(!tracks.length){ $subtitle.textContent="–ù–µ—Ç mp3 –≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"; return; }
      $status.textContent=`‚úÖ –¢—Ä–µ–∫–æ–≤: ${tracks.length} (root)`;
      renderList();
      load(0);
      setBar($seek,0);
      syncPlayUI();
    }catch(e){
      $subtitle.textContent="–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
      $status.textContent=String(e?.message||e);
    }
  })();
})();
</script>
</body>
</html>
